{% extends 'base.html' %}
{% load static %}

{% block title %}MySQL Database - Datasage Workbench{% endblock %}

{% block content %}
<div class="workbench-layout">
    <!-- Header with database info -->
    <header class="workbench-header">
        <div class="database-info">
            <h1>MySQL Database</h1>
            <span class="connection-details">{{ connection.host }} | {{ connection.database }}</span>
        </div>
        <div class="user-actions">
            <span>{{ request.user.name }}</span>
            <a href="{% url 'core:home' %}" class="btn btn-light btn-sm">Home</a>
            <a href="{% url 'core:data_connection_hub' %}" class="btn btn-light btn-sm">Change Connection</a>
            <a href="{% url 'core:logout' %}" class="logout-btn">Logout</a>
        </div>
    </header>
    
    <div class="workbench-container">
        <!-- Left sidebar: Schema browser -->
        <aside class="schema-browser">
            <div class="resizer" id="sidebar-resizer"></div>
            <div class="search-box">
                <input type="text" placeholder="Search tables..." id="table-search">
                <button class="search-btn"><i class="fas fa-search"></i></button>
            </div>
            
            <div class="schema-section">
                <div class="section-header expanded" data-section="database-schemas">
                    <i class="fas fa-chevron-down"></i>
                    <span>DATABASE SCHEMAS</span>
                </div>
                <div class="section-content visible" id="database-schemas">
                    <!-- Schema content will be populated dynamically -->
                    <div class="loading-indicator">Loading schemas...</div>
                </div>
            </div>
            
            <div class="schema-section">
                <div class="section-header" data-section="temporary-tables">
                    <i class="fas fa-chevron-right"></i>
                    <span>TEMPORARY TABLES</span>
                </div>
                <div class="section-content" id="temporary-tables">
                    <!-- Temp tables will be populated dynamically when available -->
                    <div class="no-temp-tables">No temporary tables available</div>
                </div>
            </div>
        </aside>
        
        <!-- Main workspace -->
        <main class="workspace">
            <div class="workspace-tabs">
                <div class="tab active" data-tab="sql-notebook">SQL Notebook</div>
                <div class="tab" data-tab="results">Results</div>
                <div class="tab" data-tab="dashboard">Dashboard</div>
                <div class="tab" data-tab="documentation">Documentation</div>
            </div>
            
            <div class="tab-content">
                <!-- SQL Notebook Tab -->
                <div class="tab-pane active" id="sql-notebook">
                    <!-- Natural language to SQL interface -->
                    <div class="nl-to-sql">
                        <div class="nl-input-container">
                            <input type="text" class="nl-input" placeholder="Describe your query in natural language...">
                            <button class="nl-submit">Generate SQL</button>
                        </div>
                        <div class="example-prompts">
                            <button class="example-prompt">Show all customers who made a purchase in the last 30 days</button>
                            <button class="example-prompt">Count orders by product category</button>
                            <button class="example-prompt">Find employees with highest sales in each region</button>
                            <button class="example-prompt">Calculate average order value by month</button>
                        </div>
                    </div>
                    
                    <!-- SQL Notebook Container -->
                    <div id="notebook-container" class="notebook-container" data-notebook-id="{{ notebook.uuid }}">
                        <div class="notebook-header">
                            <h3>{{ notebook.title|default:"Untitled Notebook" }}</h3>
                            <div class="notebook-actions">
                                <button id="save-notebook-btn" class="toolbar-btn">Save</button>
                            </div>
                        </div>
                        
                        <!-- Serialize cells data for JavaScript access - hidden from linters -->
                        <script type="text/javascript">
                            // This is generated by Django template engine
                            /* eslint-disable */
                            window.cellsData = JSON.parse('{% if cells %}{{ cells|escapejs }}{% else %}[]{% endif %}');
                            /* eslint-enable */
                        </script>
                        
                        <!-- Cells will be dynamically inserted here -->
                        {% if cells %}
                            <!-- Cells will be rendered by JavaScript -->
                        {% else %}
                            <!-- Show placeholder when no cells exist -->
                            <div class="empty-notebook">
                                <p>This notebook is empty. Add a cell to start working.</p>
                            </div>
                        {% endif %}
                        
                        <div class="add-cell">
                            <button id="add-cell-btn" class="add-cell-btn">+ Add Cell</button>
                        </div>
                    </div>
                </div>
                
                <!-- Results Tab -->
                <div class="tab-pane" id="results">
                    <div class="results-container">
                        <!-- Query Results Section -->
                        <div class="query-results-section">
                            <div class="results-placeholder">
                                <p>Run a query to see results here</p>
                            </div>
                        </div>
                        
                        <!-- Knowledge Graph Section -->
                        <div class="knowledge-graph-container">
                            <div class="knowledge-graph-header">
                                <div class="knowledge-graph-title">
                                    <h4>Database Knowledge Graph</h4>
                                </div>
                                <div class="knowledge-graph-controls">
                                    <div class="graph-search">
                                        <input type="text" id="graph-search-input" placeholder="Search tables or columns...">
                                        <button id="graph-search-clear" class="graph-search-clear"><i class="fas fa-times"></i></button>
                                    </div>
                                    <div class="graph-layout-control">
                                        <label for="graph-layout-select">Layout:</label>
                                        <select id="graph-layout-select">
                                            <option value="hierarchical">Hierarchical</option>
                                            <option value="force">Force-Directed</option>
                                            <option value="circular">Circular</option>
                                        </select>
                                    </div>
                                    <button id="generate-knowledge-graph">
                                        <i class="fas fa-project-diagram"></i> Generate Graph
                                    </button>
                                </div>
                            </div>
                            
                            <p id="graph-message"></p>
                            
                            <div class="knowledge-graph-content">
                                <div id="knowledge-graph-network"></div>
                                
                                <div class="knowledge-graph-sidebar">
                                    <div id="graph-stats" class="graph-stats">
                                        <div class="stat-item">
                                            <div class="stat-value">0</div>
                                            <div class="stat-label">Tables</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-value">0</div>
                                            <div class="stat-label">Columns</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-value">0</div>
                                            <div class="stat-label">Relationships</div>
                                        </div>
                                    </div>
                                    
                                    <div id="graph-node-info" class="graph-node-info">
                                        <h4>Node Information</h4>
                                        <div class="graph-node-info-content">
                                            <p>Select a node to see details</p>
                                        </div>
                                    </div>
                                    
                                    <div class="graph-legend">
                                        <h4>Legend</h4>
                                        <div class="legend-section">
                                            <h5>Column Types</h5>
                                            <div id="graph-legend-types"></div>
                                        </div>
                                        <div class="legend-section">
                                            <h5>Relationships</h5>
                                            <div id="graph-legend-relationships"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Dashboard Tab Content -->
                <div class="tab-pane" id="dashboard">
                    <div id="dashboard-container">
                        <!-- Will be populated by dashboard.js -->
                        <div class="dashboard-empty-state">
                            <p>Export your query results to create visualizations here</p>
                        </div>
                        
                        <div class="dashboard-data-controls" style="display: none;">
                            <div class="visualization-form">
                                <h3>Create Visualization</h3>
                                
                                <div class="form-group">
                                    <label for="plot-type">Chart Type</label>
                                    <select id="plot-type" class="form-control">
                                        <option value="bar">Bar Chart</option>
                                        <option value="line">Line Chart</option>
                                        <option value="scatter">Scatter Plot</option>
                                        <option value="pie">Pie Chart</option>
                                        <option value="histogram">Histogram</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="x-axis">X-Axis Column</label>
                                    <select id="x-axis" class="form-control"></select>
                                </div>
                                
                                <div class="form-group y-axis-control">
                                    <label for="y-axis">Y-Axis Column</label>
                                    <select id="y-axis" class="form-control"></select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="chart-title">Chart Title</label>
                                    <input type="text" id="chart-title" class="form-control" placeholder="Enter chart title">
                                </div>
                                
                                <button id="generate-chart" class="btn btn-primary">Generate Chart</button>
                            </div>
                        </div>
                        
                        <div id="chart-container"></div>
                    </div>
                </div>
                
                <!-- Documentation Tab -->
                <div class="tab-pane" id="documentation">
                    <div class="documentation-layout">
                        <!-- Project Documentation Section -->
                        <div class="doc-section">
                            <h3>Project Documentation</h3>
                            <p class="doc-description">Upload documentation to provide context for SQL generation</p>
                            
                            <div class="upload-area">
                                <div class="drag-drop-area">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <p>Drag and drop files here</p>
                                    <p class="small">or</p>
                                    <button class="upload-btn">Upload Files</button>
                                </div>
                            </div>
                            
                            <div class="uploaded-docs">
                                <h4>Uploaded Documentation</h4>
                                <p class="empty-state">No documentation uploaded yet</p>
                            </div>
                        </div>
                        
                        <!-- Table Metadata Section -->
                        <div class="doc-section">
                            <h3>Table Metadata</h3>
                            <p class="doc-description">Document tables and columns to improve SQL generation accuracy</p>
                            
                            <div class="table-metadata">
                                <h4>Document Specific Tables</h4>
                                
                                <div class="metadata-table">
                                    <div class="metadata-table-item">
                                        <div class="table-info">
                                            <span class="table-name">public.customers</span>
                                            <span class="table-stats">4 columns, approximately 1243 rows</span>
                                        </div>
                                        <button class="add-doc-btn">Add Documentation</button>
                                    </div>
                                    
                                    <div class="metadata-table-item">
                                        <div class="table-info">
                                            <span class="table-name">public.orders</span>
                                            <span class="table-stats">5 columns, approximately 8721 rows</span>
                                        </div>
                                        <button class="add-doc-btn">Add Documentation</button>
                                    </div>
                                    
                                    <div class="metadata-table-item">
                                        <div class="table-info">
                                            <span class="table-name">public.products</span>
                                            <span class="table-stats">5 columns, approximately 356 rows</span>
                                        </div>
                                        <button class="add-doc-btn">Add Documentation</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Global variable to track notebook status
    window.notebookInitialized = false;
    window.importFunctionsReady = false;
    
    // Debug function to check integration between scripts
    function checkIntegration() {
        const funcs = {
            addQueryExample: typeof window.addQueryExample === 'function',
            activateTab: typeof window.activateTab === 'function',
            importCellToExamples: typeof importCellToExamples === 'function'
        };
        console.log('Integration check:', funcs);
        return funcs;
    }
    
    // Wait short period then check integration
    setTimeout(checkIntegration, 1000);
</script>

<!-- Include simple-query-examples.js script -->
<script src="{% static 'js/simple-query-examples.js' %}"></script>
<script>
    // Function to get CSRF token for AJAX requests
    function getCsrfToken() {
        return document.querySelector('input[name="csrfmiddlewaretoken"]')?.value || document.cookie.match(/csrftoken=([^;]*)/)[1];
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        // Sidebar resizing functionality
        const schemaBrowser = document.querySelector('.schema-browser');
        const resizer = document.querySelector('.resizer');
        let isResizing = false;
        let startX, startWidth;
        
        if (resizer) {
            resizer.addEventListener('mousedown', function(e) {
                isResizing = true;
                startX = e.clientX;
                startWidth = schemaBrowser.offsetWidth;
                schemaBrowser.classList.add('resizing');
                
                // Disable user selection while resizing
                document.body.style.userSelect = 'none';
                document.body.style.cursor = 'ew-resize';
                
                e.preventDefault();
            });
        }
        
        document.addEventListener('mousemove', function(e) {
            if (!isResizing) return;
            
            const width = startWidth + e.clientX - startX;
            const maxWidth = window.innerWidth * 0.3; // 30% of viewport width
            const minWidth = 200;
            
            if (width >= minWidth && width <= maxWidth) {
                schemaBrowser.style.width = width + 'px';
            }
        });
        
        document.addEventListener('mouseup', function() {
            if (isResizing) {
                isResizing = false;
                schemaBrowser.classList.remove('resizing');
                
                // Restore normal behavior
                document.body.style.userSelect = '';
                document.body.style.cursor = '';
            }
        });
        
        // Tab switching functionality
        const tabs = document.querySelectorAll('.workspace-tabs .tab');
        const tabPanes = document.querySelectorAll('.tab-pane');
        let knowledgeGraphInitialized = false;
        
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                // Remove active class from all tabs and panes
                tabs.forEach(t => t.classList.remove('active'));
                tabPanes.forEach(p => p.classList.remove('active'));
                
                // Add active class to current tab and corresponding pane
                this.classList.add('active');
                const tabId = this.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
                
                // Initialize knowledge graph when results tab is first activated
                if (tabId === 'results' && !knowledgeGraphInitialized) {
                    // Initialize after a short delay to ensure DOM is ready
                    setTimeout(() => {
                        if (typeof initKnowledgeGraph === 'function') {
                            initKnowledgeGraph();
                            knowledgeGraphInitialized = true;
                        }
                    }, 100);
                }
            });
        });
        
        // Schema section expandable/collapsible functionality
        const sectionHeaders = document.querySelectorAll('.section-header');
        sectionHeaders.forEach(header => {
            header.addEventListener('click', function() {
                const section = this.getAttribute('data-section');
                const content = document.querySelector(`.section-content[data-section="${section}"]`);
                if (content) {
                    content.classList.toggle('visible');
                    
                    // Toggle the icon
                    const icon = this.querySelector('i');
                    if (icon) {
                        if (content.classList.contains('visible')) {
                            icon.className = 'fas fa-chevron-down';
                        } else {
                            icon.className = 'fas fa-chevron-right';
                        }
                    }
                }
            });
        });
        
        // Schema expandable/collapsible functionality
        const schemaHeaders = document.querySelectorAll('.schema-header');
        schemaHeaders.forEach(header => {
            header.addEventListener('click', function() {
                const schema = this.parentElement;
                const tables = schema.querySelector('.schema-tables');
                if (tables) {
                    tables.classList.toggle('visible');
                    
                    // Toggle the icon
                    const icon = this.querySelector('i');
                    if (icon) {
                        if (tables.classList.contains('visible')) {
                            icon.className = 'fas fa-chevron-down';
                        } else {
                            icon.className = 'fas fa-chevron-right';
                        }
                    }
                }
            });
        });

        // Table search functionality
        const searchInput = document.getElementById('table-search');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const tableItems = document.querySelectorAll('.table-item');
                
                tableItems.forEach(item => {
                    const tableNameElement = item.querySelector('span');
                    if (tableNameElement) {
                        const tableName = tableNameElement.textContent.toLowerCase();
                        if (tableName.includes(searchTerm)) {
                            item.style.display = 'flex';
                        } else {
                            item.style.display = 'none';
                        }
                    }
                });
            });
        }
        
        // Initialize SQL Notebook if we're on the notebook view
        const notebookContainer = document.getElementById('notebook-container');
        if (notebookContainer) {
            const notebookId = notebookContainer.dataset.notebookId;
            const cellsDataElement = document.getElementById('cells-data');
            if (cellsDataElement && notebookId) {
                const cellsData = JSON.parse(cellsDataElement.textContent || '[]');
                const notebook = new SQLNotebook(notebookId, 'notebook-container');
                notebook.loadCells(cellsData);
            }
        }
    });
</script>

<!-- CodeMirror for SQL editing -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/sql/sql.min.js"></script>

<!-- Include Plotly.js for visualizations -->
<script src="https://cdn.plot.ly/plotly-2.23.0.min.js"></script>

<!-- Include the application scripts -->
<script src="{% static 'js/notebook.js' %}"></script>
<script src="{% static 'js/schema_explorer.js' %}"></script>
<script src="{% static 'js/dashboard.js' %}"></script>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/workbench.css' %}">
<link rel="stylesheet" href="{% static 'css/notebook.css' %}">
<link rel="stylesheet" href="{% static 'css/schema_explorer.css' %}">
{% endblock %}