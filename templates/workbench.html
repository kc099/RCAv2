{% extends 'base.html' %}
{% load static %}

{% block title %}MySQL Database - Datasage Workbench{% endblock %}

{% block content %}
<div class="workbench-layout">
    <!-- Header with database info -->
    <header class="workbench-header">
        <div class="database-info">
            <h1>MySQL Database</h1>
            <span class="connection-details">{{ connection.host }} | {{ connection.database }}</span>
        </div>
        <div class="user-actions">
            <span>{{ request.user.name }}</span>
            <a href="{% url 'core:home' %}" class="btn btn-light btn-sm">Home</a>
            <a href="{% url 'core:data_connection_hub' %}" class="btn btn-light btn-sm">Change Connection</a>
            <a href="{% url 'core:logout' %}" class="logout-btn">Logout</a>
        </div>
    </header>
    
    <div class="workbench-container">
        <!-- Left sidebar: Schema browser -->
        <aside class="schema-browser">
            <div class="resizer" id="sidebar-resizer"></div>
            <div class="search-box">
                <input type="text" placeholder="Search tables..." id="table-search">
                <button class="search-btn"><i class="fas fa-search"></i></button>
            </div>
            
            <div class="schema-section">
                <div class="section-header expanded" data-section="database-schemas">
                    <i class="fas fa-chevron-down"></i>
                    <span>DATABASE SCHEMAS</span>
                </div>
                <div class="section-content visible" id="database-schemas">
                    <div class="schema expanded">
                        <div class="schema-header">
                            <i class="fas fa-database"></i>
                            <span>public</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="schema-tables visible">
                            <div class="table-item">
                                <i class="fas fa-table"></i>
                                <span>customers</span>
                            </div>
                            <div class="table-item">
                                <i class="fas fa-table"></i>
                                <span>orders</span>
                            </div>
                            <div class="table-item">
                                <i class="fas fa-table"></i>
                                <span>products</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="schema-section">
                <div class="section-header" data-section="temporary-tables">
                    <i class="fas fa-chevron-right"></i>
                    <span>TEMPORARY TABLES</span>
                </div>
                <div class="section-content" id="temporary-tables">
                    <div class="table-item temp-table">
                        <i class="fas fa-clock"></i>
                        <span>temp_customers</span>
                        <span class="row-count">(1243 rows)</span>
                    </div>
                    <div class="table-item temp-table">
                        <i class="fas fa-clock"></i>
                        <span>temp_recent_orders</span>
                        <span class="row-count">(156 rows)</span>
                    </div>
                </div>
            </div>
        </aside>
        
        <!-- Main workspace -->
        <main class="workspace">
            <div class="workspace-tabs">
                <div class="tab active" data-tab="sql-notebook">SQL Notebook</div>
                <div class="tab" data-tab="results">Results</div>
                <div class="tab" data-tab="query-examples">Query Examples</div>
                <div class="tab" data-tab="documentation">Documentation</div>
            </div>
            
            <div class="tab-content">
                <!-- SQL Notebook Tab -->
                <div class="tab-pane active" id="sql-notebook">
                    <!-- Natural language to SQL interface -->
                    <div class="nl-to-sql">
                        <div class="nl-input-container">
                            <input type="text" class="nl-input" placeholder="Describe your query in natural language...">
                            <button class="nl-submit">Generate SQL</button>
                        </div>
                        <div class="example-prompts">
                            <button class="example-prompt">Show all customers who made a purchase in the last 30 days</button>
                            <button class="example-prompt">Count orders by product category</button>
                            <button class="example-prompt">Find employees with highest sales in each region</button>
                            <button class="example-prompt">Calculate average order value by month</button>
                        </div>
                    </div>
                    
                    <!-- SQL Notebook Container -->
                    <div id="notebook-container" class="notebook-container" data-notebook-id="{{ notebook.id }}">
                        <div class="notebook-header">
                            <h3>{{ notebook.title|default:"Untitled Notebook" }}</h3>
                            <div class="notebook-actions">
                                <button id="save-notebook-btn" class="toolbar-btn">Save</button>
                            </div>
                        </div>
                        
                        <!-- Serialize cells data for JavaScript access - hidden from linters -->
                        <script type="text/javascript">
                            // This is generated by Django template engine
                            /* eslint-disable */
                            window.cellsData = {% if cells %}{{ cells|safe }}{% else %}[]{% endif %};
                            /* eslint-enable */
                        </script>
                        
                        <!-- Cells will be dynamically inserted here -->
                        {% if cells %}
                            <!-- Cells will be rendered by JavaScript -->
                        {% else %}
                            <!-- Show placeholder when no cells exist -->
                            <div class="empty-notebook">
                                <p>This notebook is empty. Add a cell to start working.</p>
                            </div>
                        {% endif %}
                        
                        <div class="add-cell">
                            <button id="add-cell-btn" class="add-cell-btn">+ Add Cell</button>
                        </div>
                    </div>
                </div>
                
                <!-- Results Tab -->
                <div class="tab-pane" id="results">
                    <div class="results-placeholder">
                        <p>Run a query to see results here</p>
                    </div>
                </div>
                
                <!-- Query Examples Tab -->
                <div class="tab-pane" id="query-examples">
                    <div class="examples-placeholder">
                        <p>Query examples will appear here</p>
                    </div>
                </div>
                
                <!-- Documentation Tab -->
                <div class="tab-pane" id="documentation">
                    <div class="documentation-layout">
                        <!-- Project Documentation Section -->
                        <div class="doc-section">
                            <h3>Project Documentation</h3>
                            <p class="doc-description">Upload documentation to provide context for SQL generation</p>
                            
                            <div class="upload-area">
                                <div class="drag-drop-area">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <p>Drag and drop files here</p>
                                    <p class="small">or</p>
                                    <button class="upload-btn">Upload Files</button>
                                </div>
                            </div>
                            
                            <div class="uploaded-docs">
                                <h4>Uploaded Documentation</h4>
                                <p class="empty-state">No documentation uploaded yet</p>
                            </div>
                        </div>
                        
                        <!-- Table Metadata Section -->
                        <div class="doc-section">
                            <h3>Table Metadata</h3>
                            <p class="doc-description">Document tables and columns to improve SQL generation accuracy</p>
                            
                            <div class="table-metadata">
                                <h4>Document Specific Tables</h4>
                                
                                <div class="metadata-table">
                                    <div class="metadata-table-item">
                                        <div class="table-info">
                                            <span class="table-name">public.customers</span>
                                            <span class="table-stats">4 columns, approximately 1243 rows</span>
                                        </div>
                                        <button class="add-doc-btn">Add Documentation</button>
                                    </div>
                                    
                                    <div class="metadata-table-item">
                                        <div class="table-info">
                                            <span class="table-name">public.orders</span>
                                            <span class="table-stats">5 columns, approximately 8721 rows</span>
                                        </div>
                                        <button class="add-doc-btn">Add Documentation</button>
                                    </div>
                                    
                                    <div class="metadata-table-item">
                                        <div class="table-info">
                                            <span class="table-name">public.products</span>
                                            <span class="table-stats">5 columns, approximately 356 rows</span>
                                        </div>
                                        <button class="add-doc-btn">Add Documentation</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Sidebar resizing functionality
        const schemaBrowser = document.querySelector('.schema-browser');
        const resizer = document.querySelector('.resizer');
        let isResizing = false;
        let startX, startWidth;
        
        if (resizer) {
            resizer.addEventListener('mousedown', function(e) {
                isResizing = true;
                startX = e.clientX;
                startWidth = schemaBrowser.offsetWidth;
                schemaBrowser.classList.add('resizing');
                
                // Disable user selection while resizing
                document.body.style.userSelect = 'none';
                document.body.style.cursor = 'ew-resize';
                
                e.preventDefault();
            });
        }
        
        document.addEventListener('mousemove', function(e) {
            if (!isResizing) return;
            
            const width = startWidth + e.clientX - startX;
            const maxWidth = window.innerWidth * 0.3; // 30% of viewport width
            const minWidth = 200;
            
            if (width >= minWidth && width <= maxWidth) {
                schemaBrowser.style.width = width + 'px';
            }
        });
        
        document.addEventListener('mouseup', function() {
            if (isResizing) {
                isResizing = false;
                schemaBrowser.classList.remove('resizing');
                
                // Restore normal behavior
                document.body.style.userSelect = '';
                document.body.style.cursor = '';
            }
        });
        
        // Tab switching
        const tabs = document.querySelectorAll('.workspace-tabs .tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                // Remove active class from all tabs
                tabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Hide all tab panes
                const tabPanes = document.querySelectorAll('.tab-pane');
                tabPanes.forEach(pane => pane.classList.remove('active'));
                
                // Show the selected tab pane
                const targetTab = this.getAttribute('data-tab');
                document.getElementById(targetTab).classList.add('active');
            });
        });
        
        // Schema section expandable/collapsible functionality
        const sectionHeaders = document.querySelectorAll('.section-header');
        sectionHeaders.forEach(header => {
            header.addEventListener('click', function() {
                const section = this.getAttribute('data-section');
                const content = document.querySelector(`.section-content[data-section="${section}"]`);
                if (content) {
                    content.classList.toggle('visible');
                    
                    // Toggle the icon
                    const icon = this.querySelector('i');
                    if (icon) {
                        if (content.classList.contains('visible')) {
                            icon.className = 'fas fa-chevron-down';
                        } else {
                            icon.className = 'fas fa-chevron-right';
                        }
                    }
                }
            });
        });
        
        // Schema expandable/collapsible functionality
        const schemaHeaders = document.querySelectorAll('.schema-header');
        schemaHeaders.forEach(header => {
            header.addEventListener('click', function() {
                const schema = this.parentElement;
                const tables = schema.querySelector('.schema-tables');
                if (tables) {
                    tables.classList.toggle('visible');
                    
                    // Toggle the icon
                    const icon = this.querySelector('i');
                    if (icon) {
                        if (tables.classList.contains('visible')) {
                            icon.className = 'fas fa-chevron-down';
                        } else {
                            icon.className = 'fas fa-chevron-right';
                        }
                    }
                }
            });
        });

        // Table search functionality
        const searchInput = document.getElementById('table-search');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const tableItems = document.querySelectorAll('.table-item');
                
                tableItems.forEach(item => {
                    const tableNameElement = item.querySelector('span');
                    if (tableNameElement) {
                        const tableName = tableNameElement.textContent.toLowerCase();
                        if (tableName.includes(searchTerm)) {
                            item.style.display = 'flex';
                        } else {
                            item.style.display = 'none';
                        }
                    }
                });
            });
        }
        
        // Initialize SQL Notebook if we're on the notebook view
        const notebookContainer = document.getElementById('notebook-container');
        if (notebookContainer) {
            const notebookId = notebookContainer.dataset.notebookId;
            const cellsDataElement = document.getElementById('cells-data');
            if (cellsDataElement && notebookId) {
                const cellsData = JSON.parse(cellsDataElement.textContent || '[]');
                const notebook = new SQLNotebook(notebookId, 'notebook-container');
                notebook.loadCells(cellsData);
            }
        }
    });
</script>

<!-- CodeMirror for SQL editing -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/sql/sql.min.js"></script>

<!-- Include the notebook.js script -->
<script src="{% static 'js/notebook.js' %}"></script>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/workbench.css' %}">
<link rel="stylesheet" href="{% static 'css/notebook.css' %}">
{% endblock %}